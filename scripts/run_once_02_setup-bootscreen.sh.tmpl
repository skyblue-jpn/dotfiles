#!/bin/bash
# This script sets up the boot screen with Plymouth themes.

set -eufo pipefail

# Installing Plymouth if not already installed
if ! pacman -Q plymouth &>/dev/null; then
  echo "üîç Plymouth not found, installing..."
  paru -S --noconfirm --needed plymouth || {
    echo "‚ùå Failed to install Plymouth. Exiting script, chezmoi apply will continue."
    exit 0
  }
else
  echo "‚úÖ Plymouth is already installed."
fi

# Installing Plymouth themes
if ! pacman -Q plymouth-theme-catppuccin-macchiato-git &>/dev/null; then
  echo "üîç plymouth catppuccin-macchiato theme not found, installing..."
  paru -S --noconfirm --needed plymouth-theme-catppuccin-macchiato-git || {
    echo "‚ùå Failed to install plymouth catppuccin-macchiato theme. Exiting script, chezmoi apply will continue."
    exit 0
  }
else
  echo "‚úÖ plymouth catppuccin-macchiato theme is already installed."
fi

# Set Plymouth theme to catppuccin-macchiato
if ! plymouth-set-default-theme -l | grep -q "catppuccin-macchiato"; then
  echo "üé® Setting Plymouth theme to catppuccin-macchiato..."
  sudo plymouth-set-default-theme -R catppuccin-macchiato || {
    echo "‚ùå Failed to set Plymouth theme. Exiting script, chezmoi apply will continue."
    exit 0
  }
else
  echo "‚úÖ Plymouth theme is already set to catppuccin-macchiato."
fi

# Update initramfs to apply Plymouth theme
echo "üîÑ Updating initramfs to apply Plymouth theme..."
sudo mkinitcpio -P || {
  echo "‚ùå Failed to update initramfs. Exiting script, chezmoi apply will continue."
  exit 0
}

# Installing Limine themes
if ! pacman -Q limine &>/dev/null; then
  echo "üîç Limine bootloader not found, installing..."
  paru -S --noconfirm --needed limine || {
    echo "‚ùå Failed to install Limine bootloader. Exiting script, chezmoi apply will continue."
    exit 0
  }
else
  echo "‚úÖ Limine bootloader is already installed."
fi

# Set Limine theme (term_palette etc.) without overwriting /boot/limine.conf
echo "üé® Installing Limine theme file (catppuccin-macchiato)..."

tmpdir="$(mktemp -d)"
trap 'rm -rf "$tmpdir"' EXIT

git clone --depth=1 https://github.com/catppuccin/limine.git "$tmpdir/limine" || {
  echo "‚ùå Failed to clone Limine themes. Exiting script, chezmoi apply will continue."
  exit 0
}

sudo install -m 0644 "$tmpdir/limine/themes/catppuccin-macchiato.conf" /boot/limine-theme.conf || {
  echo "‚ùå Failed to install /boot/limine-theme.conf. Exiting script, chezmoi apply will continue."
  exit 0
}

# Ensure /boot/limine.conf includes the theme at the end so it overrides existing term_palette: lines
if ! sudo test -f /boot/limine.conf; then
  echo "‚ùå /boot/limine.conf not found. Exiting script, chezmoi apply will continue."
  exit 0
fi

if ! sudo grep -qE '^\s*#:\s*include\s+/boot/limine-theme\.conf\s*$' /boot/limine.conf; then
  echo "‚ûï Appending theme include to /boot/limine.conf..."
  printf '\n#:include /boot/limine-theme.conf\n' | sudo tee -a /boot/limine.conf >/dev/null || {
    echo "‚ùå Failed to append include line to /boot/limine.conf. Exiting script, chezmoi apply will continue."
    exit 0
  }
else
  echo "‚úÖ /boot/limine.conf already includes /boot/limine-theme.conf"
fi

echo "‚úÖ Limine theme setup complete."

# End of script
