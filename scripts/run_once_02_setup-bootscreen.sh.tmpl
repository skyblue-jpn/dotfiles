#!/bin/bash
# This script sets up the boot screen with Plymouth and GRUB themes.

set -eufo pipefail

# Installing Plymouth if not already installed
if ! pacman -Q plymouth &>/dev/null; then
  echo "üîç Plymouth not found, installing..."
  paru -S --noconfirm --needed plymouth
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to install Plymouth. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚úÖ Plymouth is already installed."
fi

# Installing Plymouth themes
# Download plymouth-theme-catppuccin-macchiato from AUR if not already installed
if
  ! pacman -Q plymouth-theme-catppuccin-macchiato-git &
  >/dev/null
then
  echo "üîç plymouth catppuccin-macchiato theme not found, installing..."
  paru -S --noconfirm --needed plymouth-theme-catppuccin-macchiato-git
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to install plymouth catppuccin-macchiato theme. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚úÖ plymouth catppuccin-macchiato theme is already installed."
fi
# Set Plymouth theme to catppuccin-macchiato
# Check if the theme is already set
if ! plymouth-set-default-theme -l | grep -q "catppuccin-macchiato"; then
  echo "üé® Setting Plymouth theme to catppuccin-macchiato..."
  sudo plymouth-set-default-theme -R catppuccin-macchiato
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to set Plymouth theme. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚úÖ Plymouth theme is already set to catppuccin-macchiato."
fi
# Update initramfs to apply Plymouth theme
echo "üîÑ Updating initramfs to apply Plymouth theme..."
sudo mkinitcpio -P
if [ $? -ne 0 ]; then
  echo "‚ùå Failed to update initramfs. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Installing GRUB themes
# Download catppuccin-macchiato-grub-theme-git from AUR if not already installed
if ! pacman -Q catppuccin-macchiato-grub-theme-git &>/dev/null; then
  echo "üîç catppuccin-macchiato GRUB theme not found, installing..."
  paru -S --noconfirm --needed catppuccin-macchiato-grub-theme-git
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to install catppuccin-macchiato GRUB theme. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚úÖ catppuccin-macchiato GRUB theme is already installed."
fi
# Set GRUB theme to catppuccin-macchiato
# Check if the theme is already set
if ! grep -q 'GRUB_THEME="/usr/share/grub/themes/catppuccin-macchiato/theme.txt"' /etc/default/grub; then
  echo "üé® Setting GRUB theme to catppuccin-macchiato..."
  # Remove existing GRUB_THEME line if it exists
  sudo sed -i '/^GRUB_THEME=/d' /etc/default/grub
  # Add the new GRUB_THEME line
  echo 'GRUB_THEME="/usr/share/grub/themes/catppuccin-macchiato/theme.txt"' | sudo tee -a /etc/default/grub
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to set GRUB theme. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚úÖ GRUB theme is already set to catppuccin-macchiato."
fi
# Set tty theme to catppuccin-macchiato
# Edit /etc/default/grub and append the theme kernel options to GRUB_CMDLINE_LINUX if not already present
# Check if the options are already set
if ! grep -q 'vt.default_red=36,237,166,238,138,245,139,184,91,237,166,238,138,245,139,165' /etc/default/grub; then
  echo "üé® Setting GRUB tty theme to catppuccin-macchiato..."
  # Remove existing vt.default_red, vt.default_grn, vt.default_blu options if they exist
  sudo sed -i 's/vt\.default_red=[^ ]*//g' /etc/default/grub
  sudo sed -i 's/vt\.default_grn=[^ ]*//g' /etc/default/grub
  sudo sed -i 's/vt\.default_blu=[^ ]*//g' /etc/default/grub
  # Append the new options to GRUB_CMDLINE_LINUX
  sudo sed -i '/^GRUB_CMDLINE_LINUX=/ s/"$/ vt.default_red=36,237,166,238,138,245,139,184,91,237,166,238,138,245,139,165 vt.default_grn=39,135,218,212,173,189,213,192,96,135,218,212,173,189,213,173 vt.default_blu=58,150,149,159,244,230,202,224,120,150,149,159,244,230,202,203"/' /etc/default/grub
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to set GRUB tty theme. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚úÖ GRUB tty theme is already set to catppuccin-macchiato."
fi

# Update GRUB configuration to apply theme
echo "üîÑ Updating GRUB configuration to apply theme..."
sudo grub-mkconfig -o /boot/grub/grub.cfg
if [ $? -ne 0 ]; then
  echo "‚ùå Failed to update GRUB configuration. Exiting script, chezmoi apply will continue."
  exit 0
fi

# End of script
