#!/bin/bash
# Mount NTFS partition and update /etc/fstab if necessary.
# PARTITION: /dev/nvme0n1p5
# MOUNT_POINT: /media/gamedisk

set -eufo pipefail

# If not running as root, re-execute this script with sudo
if [ "$EUID" -ne 0 ]; then
  echo "üîí Root privileges required. Re-running with sudo..."
  exec sudo "$0" "$@"
fi

# Check if ntfs-3g is installed
if ! pacman -Q ntfs-3g &>/dev/null; then
  echo "üîç ntfs-3g not found, installing..."
  pacman -Syu --noconfirm ntfs-3g
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to install ntfs-3g. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚úÖ ntfs-3g is already installed."
fi

# Create mount point if it doesn't exist
MOUNT_POINT="/media/gamedisk"
if [ ! -d "$MOUNT_POINT" ]; then
  echo "üìÅ Creating mount point at $MOUNT_POINT"
  mkdir -p "$MOUNT_POINT"
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to create mount point. Exiting script, chezmoi apply will continue."
    exit 0
  fi
fi

# Get the UUID of the NTFS partition
PARTITION="/dev/nvme0n1p5"
UUID=$(blkid -s UUID -o value "$PARTITION")
if [ -z "$UUID" ]; then
  echo "‚ùå Could not find UUID for partition $PARTITION. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Backup fstab before modifying
echo "üìù Backing up /etc/fstab to /etc/fstab.bak"
cp /etc/fstab /etc/fstab.bak
if [ $? -ne 0 ]; then
  echo "‚ùå Failed to backup /etc/fstab. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Add entry to /etc/fstab if it doesn't already exist
if ! grep -q "$UUID" /etc/fstab; then
  echo "‚ûï Adding $PARTITION to /etc/fstab"
  echo "UUID=$UUID $MOUNT_POINT lowntfs-3g uid=1000,gid=1000,rw,user,exec,umask=000 0 0" >>/etc/fstab
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to add entry to /etc/fstab. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "‚ÑπÔ∏è Entry for $PARTITION already exists in /etc/fstab"
fi

# Mount the partition
echo "üîó Mounting $PARTITION at $MOUNT_POINT"
if mount "$MOUNT_POINT"; then
  echo "‚úÖ $PARTITION mounted successfully at $MOUNT_POINT"
else
  echo "‚ùå Failed to mount $PARTITION. Exiting script, chezmoi apply will continue."
  exit 0
fi

# End of script
