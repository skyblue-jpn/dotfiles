#!/bin/bash
# Final setup script: configure system settings and cache after deployment.

set -eufo pipefail

echo "🕒 Checking local RTC setting..."
if timedatectl | grep -q "RTC in local TZ: yes"; then
  echo "ℹ️ Local RTC is already set. Skipping."
else
  echo "🕒 Setting local RTC..."
  sudo timedatectl set-local-rtc 1
  if [ $? -ne 0 ]; then
    echo "❌ Failed to set local RTC. Exiting script, chezmoi apply will continue."
    exit 0
  fi
fi

echo "🎨 Applying Catppuccin Macchiato theme to fish shell..."
fish -c "fisher install catppuccin/fish"
if [ $? -ne 0 ]; then
  echo "❌ Failed to install Catppuccin theme. Exiting script, chezmoi apply will continue."
  exit 0
fi
yes | fish -c 'fish_config theme save "Catppuccin Macchiato"' || true
if [ $? -ne 0 ]; then
  echo "❌ Failed to apply fish theme. Exiting script, chezmoi apply will continue."
  exit 0
fi
echo "🐟 Changing default shell to fish..."
chsh -s /bin/fish
if [ $? -ne 0 ]; then
  echo "❌ Failed to change default shell. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Ensure bat is installed before building cache
if ! command -v bat &>/dev/null; then
  echo "🔍 bat not found, installing..."
  paru -S --noconfirm --needed bat
  if [ $? -ne 0 ]; then
    echo "❌ Failed to install bat. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "✅ bat is already installed."
fi

echo "🗃️ Building bat cache..."
bat cache --build
if [ $? -ne 0 ]; then
  echo "❌ Failed to build bat cache. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Setting uutils-coreutils, uutils-findutils and sudo-rs as default implementations
echo "🔧 Setting uutils-coreutils, uutils-findutils and sudo-rs as default implementations..."
# Ensure oxidizr-arch is installed before using
if ! command -v oxidizr-arch &>/dev/null; then
  echo "🔍 oxidizr-arch not found, installing..."
  paru -S --noconfirm --needed oxidizr-arch
  if [ $? -ne 0 ]; then
    echo "❌ Failed to install oxidizr-arch. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "✅ oxidizr-arch is already installed."
fi

sudo oxidizr-arch use --commit --assume-yes coreutils
sudo oxidizr-arch use --commit --assume-yes findutils
sudo oxidizr-arch use --commit --assume-yes sudo
if [ $? -ne 0 ]; then
  echo "❌ Failed to set default implementations. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Ensure topgrade is installed before running
if ! command -v topgrade &>/dev/null; then
  echo "🔍 topgrade not found, installing..."
  paru -S --noconfirm --needed topgrade
  if [ $? -ne 0 ]; then
    echo "❌ Failed to install topgrade. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "✅ topgrade is already installed."
fi

echo "🔄 Running topgrade for final upgrades..."
topgrade --disable chezmoi
if [ $? -ne 0 ]; then
  echo "❌ Failed to run topgrade. Exiting script, chezmoi apply will continue."
  exit 0
fi

# End of script
