#!/bin/bash
# Final setup script: configure system settings and cache after deployment.

set -eufo pipefail

echo "ğŸ•’ Checking local RTC setting..."
if timedatectl | grep -q "RTC in local TZ: yes"; then
  echo "â„¹ï¸ Local RTC is already set. Skipping."
else
  echo "ğŸ•’ Setting local RTC..."
  sudo timedatectl set-local-rtc 1
  if [ $? -ne 0 ]; then
    echo "âŒ Failed to set local RTC. Exiting script, chezmoi apply will continue."
    exit 0
  fi
fi

echo "ğŸ¨ Applying Catppuccin Macchiato theme to fish shell..."
fish -c fisher install catppuccin/fish
if [ $? -ne 0 ]; then
  echo "âŒ Failed to install Catppuccin theme. Exiting script, chezmoi apply will continue."
  exit 0
fi
yes | fish -c 'fish_config theme save "Catppuccin Macchiato"' || true
if [ $? -ne 0 ]; then
  echo "âŒ Failed to apply fish theme. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Ensure bat is installed before building cache
if ! command -v bat &>/dev/null; then
  echo "ğŸ” bat not found, installing..."
  paru -S --needed bat
  if [ $? -ne 0 ]; then
    echo "âŒ Failed to install bat. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "âœ… bat is already installed."
fi

echo "ğŸ—ƒï¸ Building bat cache..."
bat cache --build
if [ $? -ne 0 ]; then
  echo "âŒ Failed to build bat cache. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Ensure topgrade is installed before running
if ! command -v topgrade &>/dev/null; then
  echo "ğŸ” topgrade not found, installing..."
  paru -S --needed topgrade
  if [ $? -ne 0 ]; then
    echo "âŒ Failed to install topgrade. Exiting script, chezmoi apply will continue."
    exit 0
  fi
else
  echo "âœ… topgrade is already installed."
fi

echo "ğŸ”„ Running topgrade for final upgrades..."
topgrade --disable chezmoi
if [ $? -ne 0 ]; then
  echo "âŒ Failed to run topgrade. Exiting script, chezmoi apply will continue."
  exit 0
fi

# End of script
