#!/bin/bash
# This script is intended to be run once to set up paru (AUR helper) on an Arch Linux system.

set -euo pipefail

# Update mirror list to use the fastest mirrors
echo "Updating mirror list..."
sudo pacman -Sy --noconfirm --needed rate-mirrors
if [ $? -ne 0 ]; then
  echo "❌ Failed to update mirror list. Exiting script, chezmoi apply will continue."
  exit 0
fi
rate-mirrors arch | sudo tee /etc/pacman.d/mirrorlist
if [ $? -ne 0 ]; then
  echo "❌ Failed to generate new mirror list. Exiting script, chezmoi apply will continue."
  exit 0
fi

# Update the package database and upgrade all packages
echo "Updating package database and upgrading packages..."
sudo pacman -Syyu --noconfirm

# Ensure paru is installed
if ! command -v paru &>/dev/null; then
  echo "🔍 paru not found, installing..."
  git clone https://aur.archlinux.org/paru.git
  if [ $? -ne 0 ]; then
    echo "❌ Failed to clone paru. Exiting script, chezmoi apply will continue."
    exit 0
  fi
  cd paru
  makepkg -si
  if [ $? -ne 0 ]; then
    echo "❌ Failed to install paru. Exiting script, chezmoi apply will continue."
    exit 0
  fi
  cd ..
  rm -rf paru
else
  echo "✅ paru is already installed."
fi

# End of script
